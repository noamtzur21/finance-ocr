// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum DocumentType {
  expense
  income
}

enum OcrStatus {
  pending
  success
  failed
}

enum OcrJobStatus {
  pending
  running
  success
  failed
}

enum InvestmentAccountType {
  btb
  gemel
}

enum InvestmentEntryType {
  deposit
  withdrawal
  fee
  tax
}

enum BusinessType {
  exempt    // עוסק פטור
  licensed  // עוסק מורשה
  company   // חברה בע"מ
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String

  // Admin: only admin can create new users (customers)
  isAdmin Boolean @default(false)

  // Omnichannel: link incoming messages (e.g. WhatsApp via Twilio) to user
  phoneNumber String?    @unique // E.164 for webhook lookup
  externalId  String?     // e.g. Telegram chat id (optional, for future channels)

  // Business Profile
  businessType    BusinessType @default(exempt)
  businessName    String?
  taxId           String?      // ח.פ / ת.ז עסק
  vatPercent      Decimal      @default(18.0) @db.Decimal(4, 2)

  categories Category[]
  documents  Document[]
  transactions Transaction[]
  investments InvestmentAccount[]
  investmentYears InvestmentYear[]
  investmentEntries InvestmentEntry[]
  budgets    Budget[]
  credentials Credential[]
  passkeys   PasskeyCredential[]
  ocrJobs     OcrJob[]
  passwordResets PasswordReset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Category {
  id     String @id @default(uuid())
  userId String
  name   String

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Document {
  id        String       @id @default(uuid())
  userId    String
  type      DocumentType
  date      DateTime     @db.Date
  
  // Accounting fields
  amount        Decimal      @db.Decimal(12, 2) // Total
  vatAmount     Decimal      @default(0) @db.Decimal(12, 2)
  preVatAmount  Decimal      @default(0) @db.Decimal(12, 2)
  isRecognized  Decimal      @default(100.0) @db.Decimal(5, 2) // % recognized
  
  currency  String       @default("ILS")
  vendor    String
  categoryId String?
  description String?
  docNumber  String?

  fileKey   String
  fileName  String
  fileMime  String
  fileSize  Int
  sha256    String?

  ocrStatus     OcrStatus @default(pending)
  ocrConfidence Float?
  ocrText       String?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  ocrJob   OcrJob?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([userId, type])
  @@index([userId, sha256])
}

model Transaction {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime @db.Date
  amount    Decimal  @db.Decimal(12, 2)
  currency  String   @default("ILS")
  vendor    String
  description String?
  categoryId String?
  cardLast4  String?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([userId, updatedAt])
}

model InvestmentAccount {
  id        String                @id @default(uuid())
  userId    String
  slug      String
  name      String
  type      InvestmentAccountType
  provider  String?
  strategy  String?
  currency  String                @default("ILS")
  notes     String?

  // Optional: current balance the user can fill later
  currentBalance Decimal? @db.Decimal(14, 2)
  currentBalanceUpdatedAt DateTime?

  user  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  years InvestmentYear[]
  entries InvestmentEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
  @@index([userId, updatedAt])
}

model InvestmentEntry {
  id        String            @id @default(uuid())
  userId    String
  accountId String
  type      InvestmentEntryType
  date      DateTime          @db.Date
  amount    Decimal           @db.Decimal(14, 2)
  note      String?

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account InvestmentAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
  @@index([userId, updatedAt])
}

model InvestmentYear {
  id        String @id @default(uuid())
  userId    String
  accountId String
  year      Int

  deposits    Decimal @db.Decimal(14, 2) @default(0)
  withdrawals Decimal @db.Decimal(14, 2) @default(0)

  // Optional (fill if known)
  feesPaid   Decimal? @db.Decimal(14, 2)
  taxPaid    Decimal? @db.Decimal(14, 2)
  endBalance Decimal? @db.Decimal(14, 2)

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account InvestmentAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, year])
  @@index([userId, year])
  @@index([userId, updatedAt])
}

model OcrJob {
  id        String       @id @default(uuid())
  userId    String
  docId     String       @unique
  status    OcrJobStatus @default(pending)
  attempts  Int          @default(0)
  nextRunAt DateTime?
  lastError String?

  startedAt  DateTime?
  finishedAt DateTime?

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  doc  Document @relation(fields: [docId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status, nextRunAt])
}

model PasskeyCredential {
  id     String @id @default(uuid())
  userId String

  // WebAuthn credential (stored as raw bytes)
  credentialId Bytes @unique
  publicKey    Bytes
  counter      Int   @default(0)
  transports   String?
  deviceName   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Budget {
  id           String  @id @default(uuid())
  userId       String
  month        String // YYYY-MM
  expenseLimit Decimal @db.Decimal(12, 2)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId])
}

model Credential {
  id    String @id @default(uuid())
  userId String

  name  String
  email String

  passwordCiphertext String
  passwordIv         String
  passwordTag        String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, name])
}
